/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.viz.ui5.data.FlattenedDataset");jQuery.sap.require("sap.viz.library");jQuery.sap.require("sap.viz.ui5.data.Dataset");sap.viz.ui5.data.Dataset.extend("sap.viz.ui5.data.FlattenedDataset",{metadata:{library:"sap.viz",aggregations:{"dimensions":{type:"sap.viz.ui5.data.DimensionDefinition",multiple:true,singularName:"dimension"},"measures":{type:"sap.viz.ui5.data.MeasureDefinition",multiple:true,singularName:"measure"},"data":{type:"sap.ui.core.Element",multiple:true,singularName:"data",bindable:"bindable"}}}});sap.viz.ui5.data.FlattenedDataset.getMetadata().getAllAggregations()["data"]._doesNotRequireFactory=true;
sap.viz.ui5.data.FlattenedDataset.prototype.init=function(){};
sap.viz.ui5.data.FlattenedDataset.prototype.updateData=function(){this.invalidate()};
jQuery.each("add destroy get indexOf insert remove removeAll".split(" "),function(i,m){var M="FlattenedDataset manages the 'data' aggregation only via data binding. The method '"+m+"Data' therefore cannot be used programmatically!";sap.viz.ui5.data.FlattenedDataset.prototype[m+"Data"]=function(){jQuery.sap.log.error(M)}});
sap.viz.ui5.data.FlattenedDataset.prototype._createVIZFlatTable=function(){var b=this.getBinding("data"),c=b&&b.getContexts(0,b.getLength());if(!c||c.length===0){if(this._oVIZFlatTable){delete this._oVIZFlatTable;this.invalidate()}return}var a=[],m=[],f={'metadata':{'fields':[]},'data':[]},C=[];jQuery.each(this.getDimensions(),function(i,o){a.push({def:o,adapter:o._getAdapter()});f.metadata.fields.push({'id':o.getName(),'semanticType':'Dimension'})});jQuery.each(this.getMeasures(),function(i,o){m.push({def:o,adapter:o._getAdapter()});f.metadata.fields.push({'id':o.getName(),'semanticType':'Measure'})});jQuery.each(c,function(I,o){if(!f.data[I]){f.data[I]=[]}for(var i=0;i<a.length;i++){var v=a[i].adapter(o);f.data[I].push(v)}for(var j=0;j<m.length;j++){var v=m[j].adapter(o);f.data[I].push(v)}C[I]=o});this._aFlatContextLookup=C;this._oVIZFlatTable=new sap.viz.api.data.FlatTableDataset(f)};
sap.viz.ui5.data.FlattenedDataset.prototype.getVIZFlatDataset=function(){if(!this._oVIZFlatTable&&sap.viz.__svg_support){this._createVIZFlatTable()}return this._oVIZFlatTable||null};
sap.viz.ui5.data.FlattenedDataset.prototype._createVIZCrosstab=function(){var b=this.getBinding("data"),c=b&&b.getContexts(0,b.getLength());if(!c||c.length===0){if(this._oVIZCrosstab){delete this._oVIZCrosstab;delete this._aCrossContextLookup;delete this._aFlatContextLookup;this.invalidate()}return}var a=[],A=[],m=[],e=[],C=[];jQuery.each(this.getDimensions(),function(i,l){if(l.getAxis()===1){a.push({def:l,adapter:l._getAdapter()})}else if(l.getAxis()===2){A.push({def:l,adapter:l._getAdapter()})}else{throw new Error("currently, only axis 1 and 2 are supported")}});jQuery.each(this.getMeasures(),function(i,l){m.push({def:l,adapter:l._getAdapter()});e.push([])});function g(q,r,s){var l=q.length,V,i;if(l===0){return 0}V=[];for(i=0;i<l;i++){V.push(q[i].adapter(s))}for(i=0,l=r.length;i<l;i++){if(jQuery.sap.equal(r[i],V)){return i}}r.push(V);return r.length-1}var f=[];var h=[];jQuery.each(c,function(I,l){var q=g(a,f,l);var r=g(A,h,l);for(var i=0;i<m.length;i++){var s=m[i].adapter(l);if(a.length===0&&A.length===0){if(e[i][0]===undefined){e[i][0]=[]}e[i][0].push(s)}else{(e[i][r]=(e[i][r]||[]))[q]=s}}if(a.length===0&&A.length===0){q=I}(C[r]||(C[r]=[]))[q]=l});var L=f.length;var k=Math.max(h.length,1);for(var j=0;j<k;j++){for(var i=0;i<m.length;i++){var d=e[i][j];if(!d){d=e[i][j]=[]}if(d.length<L){d[L-1]=undefined}}if(!C[j]){C[j]=[]}if(!C[j].length<L){C[j][L]=undefined}}var n={};if(a.length>0){if(n.analysisAxis===undefined){n.analysisAxis=[]}var o={index:1,data:[]};for(var i=0;i<a.length;i++){var v=[];for(var j=0;j<f.length;j++){v[j]=f[j][i]}o.data.push({name:a[i].def.getName(),values:v})}n.analysisAxis.push(o)}if(A.length>0){if(n.analysisAxis===undefined){n.analysisAxis=[]}var o={index:2,data:[]};for(var i=0;i<A.length;i++){var v=[];for(var j=0;j<h.length;j++){v[j]=h[j][i]}o.data.push({name:A[i].def.getName(),values:v})}n.analysisAxis.push(o)}if(m.length>0){n.measureValuesGroup=[];for(var i=0;i<m.length;i++){if(!n.measureValuesGroup[m[i].def.getGroup()-1]){n.measureValuesGroup[m[i].def.getGroup()-1]={index:m[i].def.getGroup(),data:[]}}n.measureValuesGroup[m[i].def.getGroup()-1].data.push({name:m[i].def.getName(),values:e[i]})}for(var i=0,p=n.measureValuesGroup.length;i<p;i++){if(n.measureValuesGroup[i]===undefined){throw new Error("Measure Group "+(i+1)+" is missing.");break}}}this._oVIZCrosstab=new sap.viz.data.CrosstableDataset();this._oVIZCrosstab.setData(n);if(this._defaultSelectionInfo){this._oVIZCrosstab.info(this._defaultSelectionInfo)}if(this._info){this._oVIZCrosstab.info(this._info)}this._aCrossContextLookup=C};
sap.viz.ui5.data.FlattenedDataset.prototype.getVIZDataset=function(){if(!this._oVIZCrosstab&&sap.viz.__svg_support){this._createVIZCrosstab()}return this._oVIZCrosstab||null};
sap.viz.ui5.data.FlattenedDataset.prototype.invalidate=function(o){if(this._oVIZCrosstab){delete this._oVIZCrosstab;delete this._aCrossContextLookup;delete this._aFlatContextLookup}sap.ui.core.Element.prototype.invalidate.apply(this,arguments)};
sap.viz.ui5.data.FlattenedDataset.prototype.setDefaultSelection=function(s){this._defaultSelectionInfo={'type':'defaultSelection','value':s}};
sap.viz.ui5.data.FlattenedDataset.prototype.info=function(v){if(v instanceof Array){this._info=v}else if(v===undefined||typeof v==='string'){if(this._oVIZCrosstab){return this._oVIZCrosstab.info.apply(this._oVIZCrosstab,arguments)}}};
sap.viz.ui5.data.FlattenedDataset.prototype.findContext=function(c){if(this._aCrossContextLookup&&c.dii_a2!=undefined&&c.dii_a1!=undefined&&typeof c==='object'){return this._aCrossContextLookup[c.dii_a2]&&this._aCrossContextLookup[c.dii_a2][c.dii_a1]}else if(this._aFlatContextLookup&&c._id!==undefined&&typeof c==='object'){return this._aFlatContextLookup[c._id]}};
